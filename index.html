<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ESP32 BLE Controller</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-4">
  <div class="w-full max-w-4xl bg-white rounded-lg shadow-lg p-6">
    <h1 class="text-2xl font-bold text-center text-gray-800 mb-6">ESP32 BLE Controller</h1>

    <!-- Connection Status -->
    <div class="mb-4 flex justify-between items-center">
      <button id="connect" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded">Connect to BLE</button>
      <span id="status" class="text-gray-600">Disconnected</span>
    </div>

    <!-- Tabs -->
    <div class="border-b border-gray-200">
      <ul class="flex flex-wrap -mb-px text-sm font-medium text-center text-gray-500">
        <li class="mr-2">
          <button class="tab-button inline-block p-4 rounded-t-lg border-b-2 border-transparent hover:text-gray-600 hover:border-gray-300 active" data-tab="controls">Controls</button>
        </li>
        <li class="mr-2">
          <button class="tab-button inline-block p-4 rounded-t-lg border-b-2 border-transparent hover:text-gray-600 hover:border-gray-300" data-tab="pid">PID Tuning</button>
        </li>
        <li class="mr-2">
          <button class="tab-button inline-block p-4 rounded-t-lg border-b-2 border-transparent hover:text-gray-600 hover:border-gray-300" data-tab="sensors">Sensors</button>
        </li>
        <li class="mr-2">
          <button class="tab-button inline-block p-4 rounded-t-lg border-b-2 border-transparent hover:text-gray-600 hover:border-gray-300" data-tab="angle">Angle Plot</button>
        </li>
        <li>
          <button class="tab-button inline-block p-4 rounded-t-lg border-b-2 border-transparent hover:text-gray-600 hover:border-gray-300" data-tab="debug">Debug Log</button>
        </li>
      </ul>
    </div>

    <!-- Tab Content -->
    <div id="tab-content" class="mt-4">
      <!-- Controls Tab -->
      <div id="controls" class="tab-content">
        <div class="grid grid-cols-3 gap-4">
          <button id="forward" disabled class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded disabled:opacity-50">Forward</button>
          <button id="left" disabled class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded disabled:opacity-50">Left</button>
          <button id="right" disabled class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded disabled:opacity-50">Right</button>
          <button id="backward" disabled class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded disabled:opacity-50">Backward</button>
          <button id="stop" disabled class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded disabled:opacity-50">Stop</button>
          <button id="switchMode" disabled class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded disabled:opacity-50">Switch Mode</button>
        </div>
        <div class="mt-4">
          <p class="text-gray-600">Current Mode: <span id="modeStatus">Balancing Mode</span></p>
        </div>
      </div>

      <!-- PID Tuning Tab -->
      <div id="pid" class="tab-content hidden">
        <h2 class="text-lg font-semibold text-gray-700 mb-4">PID Tuning</h2>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-gray-600">Kp</label>
            <input id="kp" type="number" step="0.1" value="60.0" class="w-full border rounded p-2" disabled>
          </div>
          <div>
            <label class="block text-gray-600">Ki</label>
            <input id="ki" type="number" step="0.1" value="270.0" class="w-full border rounded p-2" disabled>
          </div>
          <div>
            <label class="block text-gray-600">Kd</label>
            <input id="kd" type="number" step="0.1" value="2.2" class="w-full border rounded p-2" disabled>
          </div>
          <div>
            <label class="block text-gray-600">Setpoint</label>
            <input id="setpoint" type="number" step="0.1" value="3.8" class="w-full border rounded p-2" disabled>
          </div>
        </div>
        <button id="updatePID" disabled class="mt-4 bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded disabled:opacity-50">Update PID</button>
      </div>

      <!-- Sensors Tab -->
      <div id="sensors" class="tab-content hidden">
        <h2 class="text-lg font-semibold text-gray-700 mb-4">Sensor Data</h2>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <p class="text-gray-600">Accelerometer X: <span id="accX">N/A</span> g</p>
          </div>
          <div>
            <p class="text-gray-600">Accelerometer Y: <span id="accY">N/A</span> g</p>
          </div>
          <div>
            <p class="text-gray-600">Accelerometer Z: <span id="accZ">N/A</span> g</p>
          </div>
          <div>
            <p class="text-gray-600">Gyroscope X: <span id="gyroX">N/A</span> deg/s</p>
          </div>
          <div>
            <p class="text-gray-600">Gyroscope Y: <span id="gyroY">N/A</span> deg/s</p>
          </div>
          <div>
            <p class="text-gray-600">Gyroscope Z: <span id="gyroZ">N/A</span> deg/s</p>
          </div>
          <div>
            <p class="text-gray-600">Motor Speed: <span id="motorSpeed">N/A</span></p>
          </div>
          <div>
            <p class="text-gray-600">Mode: <span id="mode">N/A</span></p>
          </div>
        </div>
      </div>

      <!-- Angle Plot Tab -->
      <div id="angle" class="tab-content hidden">
        <h2 class="text-lg font-semibold text-gray-700 mb-4">Angle Over Time</h2>
        <canvas id="angleChart" class="w-full h-64"></canvas>
      </div>

      <!-- Debug Log Tab -->
      <div id="debug" class="tab-content hidden">
        <h2 class="text-lg font-semibold text-gray-700 mb-4">Debug Log</h2>
        <div id="output" class="bg-gray-50 border rounded p-4 h-64 overflow-y-auto text-left text-gray-600"></div>
      </div>
    </div>
  </div>

  <script>
    const SERVICE_UUID = '4fafc201-1fb5-459e-8fcc-c5c9c331914b';
    const CHARACTERISTIC_UUID = 'beb5483e-36e1-4688-b7f5-ea07361b26a8';

    let bleDevice;
    let characteristic;
    let isControlMode = false;
    let angleData = [];
    let angleChart;

    // Initialize Chart
    const ctx = document.getElementById('angleChart').getContext('2d');
    angleChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label: 'Angle (degrees)',
          data: [],
          borderColor: 'rgba(75, 192, 192, 1)',
          fill: false
        }]
      },
      options: {
        responsive: true,
        scales: {
          x: { title: { display: true, text: 'Time' } },
          y: { title: { display: true, text: 'Angle (degrees)' } }
        }
      }
    });

    const log = (message) => {
      const output = document.getElementById('output');
      const newLog = document.createElement('div');
      newLog.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
      output.appendChild(newLog);
      output.scrollTop = output.scrollHeight;
    };

    const updateStatus = (status) => {
      document.getElementById('status').textContent = status;
    };

    const connectToBLE = async () => {
      try {
        log('Requesting BLE device...');
        bleDevice = await navigator.bluetooth.requestDevice({
          acceptAllDevices: true,
          optionalServices: [SERVICE_UUID]
        });

        log('Connecting to GATT server...');
        const server = await bleDevice.gatt.connect();

        log('Getting service...');
        const service = await server.getPrimaryService(SERVICE_UUID);

        log('Getting characteristic...');
        characteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);

        log('Starting notifications...');
        await characteristic.startNotifications();
        characteristic.addEventListener('characteristicvaluechanged', handleNotifications);

        log('Connected to BLE device!');
        updateStatus('Connected');
        enableControls(true);

        bleDevice.addEventListener('gattserverdisconnected', () => {
          log('Device disconnected');
          updateStatus('Disconnected');
          enableControls(false);
        });
      } catch (error) {
        log(`Error: ${error.message}`);
        updateStatus('Error');
      }
    };

    const handleNotifications = (event) => {
      const value = new TextDecoder().decode(event.target.value);
      log(`Received: ${value}`);

      // Parse sensor data (format: "accX,accY,accZ,gyroX,gyroY,gyroZ,angle,motorSpeed,mode")
      const data = value.split(',');
      if (data.length >= 9) {
        const sensorData = {
          accX: parseFloat(data[0]),
          accY: parseFloat(data[1]),
          accZ: parseFloat(data[2]),
          gyroX: parseFloat(data[3]),
          gyroY: parseFloat(data[4]),
          gyroZ: parseFloat(data[5]),
          angle: parseFloat(data[6]),
          motorSpeed: parseInt(data[7]),
          mode: parseInt(data[8])
        };

        // Update sensor display
        document.getElementById('accX').textContent = sensorData.accX.toFixed(2);
        document.getElementById('accY').textContent = sensorData.accY.toFixed(2);
        document.getElementById('accZ').textContent = sensorData.accZ.toFixed(2);
        document.getElementById('gyroX').textContent = sensorData.gyroX.toFixed(2);
        document.getElementById('gyroY').textContent = sensorData.gyroY.toFixed(2);
        document.getElementById('gyroZ').textContent = sensorData.gyroZ.toFixed(2);
        document.getElementById('motorSpeed').textContent = sensorData.motorSpeed;
        document.getElementById('mode').textContent = sensorData.mode === 0 ? 'Balancing' : 'Control';

        // Update mode status
        isControlMode = sensorData.mode === 1;
        document.getElementById('modeStatus').textContent = isControlMode ? 'Control Mode' : 'Balancing Mode';

        // Update angle chart
        const time = new Date().toLocaleTimeString();
        angleData.push({ time, angle: sensorData.angle });
        if (angleData.length > 50) angleData.shift();
        angleChart.data.labels = angleData.map(d => d.time);
        angleChart.data.datasets[0].data = angleData.map(d => d.angle);
        angleChart.update();
      }
    };

    const sendCommand = async (command) => {
      if (characteristic) {
        const data = new TextEncoder().encode(command);
        await characteristic.writeValue(data);
        log(`Sent: ${command}`);
      }
    };

    const enableControls = (enabled) => {
      document.getElementById('forward').disabled = !enabled || !isControlMode;
      document.getElementById('backward').disabled = !enabled || !isControlMode;
      document.getElementById('left').disabled = !enabled || !isControlMode;
      document.getElementById('right').disabled = !enabled || !isControlMode;
      document.getElementById('stop').disabled = !enabled || !isControlMode;
      document.getElementById('switchMode').disabled = !enabled;
      document.getElementById('kp').disabled = !enabled;
      document.getElementById('ki').disabled = !enabled;
      document.getElementById('kd').disabled = !enabled;
      document.getElementById('setpoint').disabled = !enabled;
      document.getElementById('updatePID').disabled = !enabled;
    };

    // Tab switching
    document.querySelectorAll('.tab-button').forEach(button => {
      button.addEventListener('click', () => {
        const tab = button.getAttribute('data-tab');
        document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
        document.getElementById(tab).classList.remove('hidden');
        document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('border-blue-500', 'text-gray-600'));
        button.classList.add('border-blue-500', 'text-gray-600');
      });
    });

    // Event Listeners
    document.getElementById('connect').addEventListener('click', connectToBLE);

    document.getElementById('forward').addEventListener('click', () => sendCommand('CMD:FWD'));
    document.getElementById('backward').addEventListener('click', () => sendCommand('CMD:BWD'));
    document.getElementById('left').addEventListener('click', () => sendCommand('CMD:LEFT'));
    document.getElementById('right').addEventListener('click', () => sendCommand('CMD:RIGHT'));
    document.getElementById('stop').addEventListener('click', () => sendCommand('CMD:STOP'));

    document.getElementById('switchMode').addEventListener('click', () => {
      isControlMode = !isControlMode;
      sendCommand(`MODE:${isControlMode ? 1 : 0}`);
      log(`Switched to ${isControlMode ? 'Control Mode' : 'Balancing Mode'}`);
      document.getElementById('modeStatus').textContent = isControlMode ? 'Control Mode' : 'Balancing Mode';
      enableControls(bleDevice && bleDevice.gatt.connected);
    });

    document.getElementById('updatePID').addEventListener('click', () => {
      const kp = document.getElementById('kp').value;
      const ki = document.getElementById('ki').value;
      const kd = document.getElementById('kd').value;
      const setpoint = document.getElementById('setpoint').value;
      sendCommand(`PID:${kp},${ki},${kd},${setpoint}`);
      log(`Updated PID: Kp=${kp}, Ki=${ki}, Kd=${kd}, Setpoint=${setpoint}`);
    });

    // Show controls tab by default
    document.querySelector('.tab-button[data-tab="controls"]').click();
  </script>
</body>
</html>
