<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Self-Balancing Robot Control</title>
</head>
<body>
    <h1>Self-Balancing Robot Control</h1>
    <button id="connectButton">Connect</button>
    <div id="controls" style="display:none;">
        <h2>Controls</h2>
        <h3>PID Parameters</h3>
        <label for="kp">Kp:</label>
        <input type="number" id="kp" step="0.1" value="60.0"><br>
        <label for="ki">Ki:</label>
        <input type="number" id="ki" step="0.1" value="270.0"><br>
        <label for="kd">Kd:</label>
        <input type="number" id="kd" step="0.1" value="2.2"><br>
        <label for="setpoint">Setpoint (offset angle):</label>
        <input type="number" id="setpoint" step="0.1" value="1.2"><br>
        <button id="updatePID">Update PID</button><br>
        
        <h3>Mode</h3>
        <label for="mode">Mode:</label>
        <select id="mode">
            <option value="0">Balancing</option>
            <option value="1">Control</option>
        </select><br>
        
        <h3>Commands (only in Control Mode)</h3>
        <button id="fwd">Forward</button>
        <button id="bwd">Backward</button>
        <button id="left">Left</button>
        <button id="right">Right</button>
        <button id="stop">Stop</button><br>
        
        <h3>Current Status</h3>
        <label for="angle">Current Angle:</label>
        <span id="angle">0.0</span> degrees<br>
        
        <button id="disconnectButton">Disconnect</button>
    </div>
    
    <script>
        let device;
        let server;
        let service;
        let characteristic;
        
        document.getElementById('connectButton').addEventListener('click', connect);
        
        async function connect() {
            try {
                device = await navigator.bluetooth.requestDevice({
                    filters: [{ services: ['4fafc201-1fb5-459e-8fcc-c5c9c331914b'] }]
                });
                server = await device.gatt.connect();
                service = await server.getPrimaryService('4fafc201-1fb5-459e-8fcc-c5c9c331914b');
                characteristic = await service.getCharacteristic('beb5483e-36e1-4688-b7f5-ea07361b26a8');
                
                await characteristic.startNotifications();
                characteristic.addEventListener('characteristicvaluechanged', handleData);
                
                document.getElementById('controls').style.display = 'block';
                
                device.addEventListener('gattserverdisconnected', () => {
                    console.log('Device disconnected');
                    document.getElementById('controls').style.display = 'none';
                });
            } catch (error) {
                console.error('Connection error:', error);
            }
        }
        
        function handleData(event) {
            const value = event.target.value;
            const data = new TextDecoder().decode(value);
            const parts = data.split(',');
            if (parts.length >= 9) {
                const angle = parseFloat(parts[6]);
                document.getElementById('angle').textContent = angle.toFixed(1);
                const currentMode = parseInt(parts[8]);
                document.getElementById('mode').value = currentMode;
            }
        }
        
        document.getElementById('updatePID').addEventListener('click', updatePID);
        
        async function updatePID() {
            const kp = document.getElementById('kp').value;
            const ki = document.getElementById('ki').value;
            const kd = document.getElementById('kd').value;
            const setpoint = document.getElementById('setpoint').value;
            const message = `PID:${kp},${ki},${kd},${setpoint}`;
            await characteristic.writeValue(new TextEncoder().encode(message));
        }
        
        document.getElementById('mode').addEventListener('change', changeMode);
        
        async function changeMode() {
            const mode = document.getElementById('mode').value;
            const message = `MODE:${mode}`;
            await characteristic.writeValue(new TextEncoder().encode(message));
        }
        
        document.getElementById('fwd').addEventListener('click', () => sendCommand('FWD'));
        document.getElementById('bwd').addEventListener('click', () => sendCommand('BWD'));
        document.getElementById('left').addEventListener('click', () => sendCommand('LEFT'));
        document.getElementById('right').addEventListener('click', () => sendCommand('RIGHT'));
        document.getElementById('stop').addEventListener('click', () => sendCommand('STOP'));
        
        async function sendCommand(cmd) {
            const message = `CMD:${cmd}`;
            await characteristic.writeValue(new TextEncoder().encode(message));
        }
        
        document.getElementById('disconnectButton').addEventListener('click', disconnect);
        
        async function disconnect() {
            if (device && device.gatt.connected) {
                await device.gatt.disconnect();
            }
        }
    </script>
</body>
</html>
